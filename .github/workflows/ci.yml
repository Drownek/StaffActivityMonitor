name: Bukkit Plugin CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build --no-daemon --stacktrace

      - name: Check for build errors
        if: failure()
        run: |
          echo "::error::Build failed! Check the logs above for details."
          exit 1

  test-minecraft-versions:
    name: Test Minecraft Versions
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        minecraft-task:
          - run1_8_8
          - run1_12_2
          - run1_13_2
          - run1_16_5
          - run1_17_1
          - run1_18_2
          - run1_19_4
          - run1_21_11

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build plugin
        run: ./gradlew build --no-daemon

      - name: Run ${{ matrix.minecraft-task }}
        id: run_server
        timeout-minutes: 5
        continue-on-error: true
        run: |
          echo "Running task: ${{ matrix.minecraft-task }}"
          
          # Run the gradle task and capture output
          ./gradlew ${{ matrix.minecraft-task }} --no-daemon 2>&1 | tee server_output.log
          
          # Check if server started successfully (look for "Done" message)
          if grep -q "Done" server_output.log; then
            echo "✓ Server started successfully"
            echo "server_started=true" >> $GITHUB_OUTPUT
          else
            echo "✗ Server failed to start - 'Done' message not found"
            echo "server_started=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for plugin errors
        if: steps.run_server.outputs.server_started == 'true'
        run: |
          echo "Checking for stack traces from StaffActivityMonitor plugin..."
          
          # Get plugin name from project (adjust if needed)
          PLUGIN_NAME="StaffActivityMonitor"
          
          # Check for stack traces mentioning our plugin
          if grep -i "exception\|error" server_output.log | grep -i "$PLUGIN_NAME"; then
            echo "::error::Found stack traces related to $PLUGIN_NAME plugin!"
            echo "=== Error Details ==="
            grep -i "exception\|error" server_output.log | grep -i "$PLUGIN_NAME" || true
            echo "===================="
            exit 1
          else
            echo "✓ No plugin-related errors found in logs"
          fi
          
          # Additional check for any ERROR level logs from our plugin
          if grep -E "\[.*ERROR.*\].*$PLUGIN_NAME" server_output.log; then
            echo "::error::Found ERROR level logs from $PLUGIN_NAME!"
            grep -E "\[.*ERROR.*\].*$PLUGIN_NAME" server_output.log
            exit 1
          fi
          
          echo "✓ All checks passed for ${{ matrix.minecraft-task }}"

      - name: Check if server failed to start
        if: steps.run_server.outputs.server_started == 'false'
        run: |
          echo "::error::Server did not complete startup for ${{ matrix.minecraft-task }}"
          echo "=== Last 50 lines of output ==="
          tail -n 50 server_output.log
          echo "================================"
          exit 1

      - name: Upload server logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs-${{ matrix.minecraft-task }}
          path: |
            server_output.log
            logs/
            *.log
          retention-days: 7

  summary:
    name: Test Summary
    needs: test-minecraft-versions
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-minecraft-versions.result }}" == "success" ]; then
            echo "✓ All Minecraft version tests passed!"
          else
            echo "✗ Some Minecraft version tests failed"
            exit 1
          fi