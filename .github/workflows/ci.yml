name: Bukkit Plugin CI

on:
  push:
    branches: [ master, test ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: Build JAR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install Java 16 (for core module toolchain)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '16'

      # Install Java 17 last (this becomes JAVA_HOME for Gradle)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Build Plugin
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-jar
          path: build/libs/*.jar
          retention-days: 1

  smoke-test-matrix:
    name: Smoke Test ${{ matrix.minecraft-task }}
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        minecraft-task: [ run1_17_1, run1_18_2, run1_19_4, run1_21_11 ]

    steps:
      - uses: actions/checkout@v4

      # Install Java 16 (for core module toolchain)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '16'

      # Install Java 19 (for Minecraft 1.19.4)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '19'

      # Install Java 21 (for Minecraft 1.21)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install Java 17 last (this becomes JAVA_HOME for Gradle)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Run Startup Check
        id: startup_check
        timeout-minutes: 3
        run: |
          echo "Starting ${{ matrix.minecraft-task }}..."

          # Run server with a timeout, capture all output
          # We use '|| true' so the step doesn't fail immediately on timeout
          timeout 90s ./gradlew ${{ matrix.minecraft-task }} --no-daemon 2>&1 | tee server.log || true

      - name: Verify Log Messages
        run: |
          if ! grep -Fq "Done (" server.log; then
            echo "::error::Server never finished starting!"
            echo "=== Last 20 lines of logs ==="
            tail -n 20 server.log
            exit 1
          fi

          if grep -Fq "[StaffActivityMonitor] Plugin loaded successfully!" server.log; then
            echo "âœ… Plugin loaded successfully!"
          else
            echo "::error::Plugin did not print success message!"
            echo "=== Full Log for Context ==="
            cat server.log
            exit 1
          fi

  e2e-test:
    name: Run E2E Tests (Attempt ${{ matrix.run }})
    needs: smoke-test-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        run: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

    steps:
      - uses: actions/checkout@v4

      # Install Java 16 (for core module toolchain)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '16'

      # Install Java 19 (for Minecraft 1.19.4)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '19'

      # Install Java 21 (for Minecraft 1.21)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install Java 17 last (this becomes JAVA_HOME for Gradle)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Run E2E Suite
        run: |
          chmod +x gradlew
          ./gradlew testE2E --no-daemon --info

      - name: Upload Test Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-reports-run-${{ matrix.run }}
          path: build/reports/tests/